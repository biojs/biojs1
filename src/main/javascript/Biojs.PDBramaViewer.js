
Biojs.PDBramaViewer = Biojs.extend ( {
	constructor: function(options) {
		var self = this;
		for(k in options) self[k] = options[k];
		self.colormaker = Biojs.theOnlyPDBcolourFactory;
		self.chainids = {model:'1', chain:'A', entity:'1'};
		self.makeMenuAndRaphaDivs();
		self.setupPDBdatabrokerAndLaunch();
		jQuery.Topic("PDBchainSelUnselEvent").subscribe( function(data) {
			self.chainids = null;
			if(data.selstate==true) self.chainids = data;
			self.draw();
		} );
	},
	makeMenuAndRaphaDivs: function() {
		var self = this;
		self.menudivheight = 25;
		self.raphadivheight = Math.floor((self.size - self.menudivheight)/1)*1;
		self.menudivid = self.divid + "_menu";
		self.raphadivid = self.divid + "_rapha";
		document.getElementById(self.divid).innerHTML =
			'<div class="PDBramaviewer_menudiv"  style="width:'+self.raphadivheight+'px;height:'+ self.menudivheight+'px;" id="'+self.menudivid+'"></div>' +
			'<div class="PDBramaviewer_raphadiv" style="width:'+self.raphadivheight+'px;height:'+self.raphadivheight+'px;" id="'+self.raphadivid+'"></div>';
	},
	setupPDBdatabrokerAndLaunch: function() {
		var self = this;
		self.pdb = new Biojs.getPDBdatabroker(self.apiURL);
		var successCallback = function() {
			self.entry = self.pdb.makeEntry(self.pdbid, apidata);
			self.entry.makeEntities(apidata); 
			self.entry.makeResidueListing(apidata);
			self.entry.makeRamaRotaListing(apidata);
			self.draw();
		};
		if(self.apidata) { apidata = self.apidata; successCallback(self.apidata) ; return; }
		var urlstr = '', apiURLs = [
			"/pdb/entry/summary/" + self.pdbid,
			"/pdb/entry/entities/" + self.pdbid,
			"/pdb/entry/residue_listing/" + self.pdbid,
			"/validation/rama_sidechain_listing/entry/" + self.pdbid
		];
		for(var ai=0; ai < apiURLs.length; ai++) urlstr += apiURLs[ai] + ",";
		urlstr = urlstr.replace(/,$/, "");
		jQuery.ajax({
			url: self.apiURL + '/callgroup/' + urlstr,
			data: {'varname':'apidata'},
			dataType: 'script',
			crossDomain: 'true',
			type: 'GET',
			success: successCallback,
			error: function(jqXHR, textStatus, errorThrown) {
				alert("There was an unidentified error in obtaining data from PDBe API - please report to pdbehelp@ebi.ac.uk");
				document.getElementById(self.raphadivid).innerHTML = "Error!";
			}
		});
	},
	drawAxes: function() {
		var self = this;
		var xy = self.phipsiToRaphaXY(-180,180);
		self.rapha.rapha.rect(xy[0], xy[1], 360*self.deg2len, 360*self.deg2len)
		var phistep = 30, a=null, b=null, dotattr={"stroke-dasharray":"-"};
		for(var phi=-180+phistep; phi < 180; phi += phistep) {
			a = self.phipsiToRaphaXY(phi, -180);
			b = self.phipsiToRaphaXY(phi,  180);
			self.rapha.rapha.path(["M", a[0], a[1], "L", b[0], b[1]]).attr(dotattr);
			a = self.phipsiToRaphaXY(-180, phi);
			b = self.phipsiToRaphaXY( 180, phi);
			self.rapha.rapha.path(["M", a[0], a[1], "L", b[0], b[1]]).attr(dotattr);
		}
	},
	drawRamaContours: function() {
		var self = this;
// {{{ Ramachandran contour data
	var contourdata = [
     2 , 2 , 2 ,
     0 , -170 , -180 ,
     1 , -165 , -174 ,
     1 , -159 , -173 ,
     1 , -150 , -174 ,
     1 , -145 , -176 ,
     1 , -136 , -180 ,
     0 , -78 , -45 ,
     1 , -69 , -47 ,
     1 , -60 , -46 ,
     1 , -55 , -41 ,
     1 , -54 , -34 ,
     1 , -56 , -29 ,
     1 , -61 , -24 ,
     1 , -69 , -20 ,
     1 , -74 , -17 ,
     1 , -84 , -15 ,
     1 , -90 , -14 ,
     1 , -95 , -17 ,
     1 , -96 , -24 ,
     1 , -94 , -29 ,
     1 , -90 , -36 ,
     1 , -84 , -41 ,
     1 , -78 , -45 ,
     0 , -101 , 15 ,
     1 , -95 , 12 ,
     1 , -88 , 15 ,
     1 , -89 , 24 ,
     1 , -90 , 30 ,
     1 , -95 , 37 ,
     1 , -100 , 34 ,
     1 , -105 , 28 ,
     1 , -105 , 20 ,
     1 , -101 , 15 ,
     0 , -160 , 155 ,
     1 , -155 , 152 ,
     1 , -145 , 151 ,
     1 , -135 , 154 ,
     1 , -129 , 158 ,
     1 , -125 , 164 ,
     1 , -129 , 174 ,
     1 , -135 , 178 ,
     1 , -136 , 180 ,
     0 , -166 , 159 ,
     1 , -160 , 155 ,
     0 , -166 , 159 ,
     1 , -169 , 166 ,
     1 , -171 , 174 ,
     1 , -170 , 180 ,
     0 , -67 , -174 ,
     1 , -64 , -180 ,
     2 , 3 , 3 ,
     0 , 174 , -180 ,
     1 , 174 , -173 ,
     1 , 178 , -164 ,
     1 , 180 , -162 ,
     0 , -70 , -169 ,
     1 , -67 , -174 ,
     0 , -70 , -169 ,
     1 , -74 , -163 ,
     1 , -79 , -159 ,
     1 , -90 , -156 ,
     1 , -100 , -156 ,
     1 , -110 , -157 ,
     1 , -119 , -157 ,
     1 , -129 , -157 ,
     1 , -140 , -156 ,
     1 , -150 , -155 ,
     1 , -159 , -155 ,
     1 , -169 , -156 ,
     1 , -177 , -159 ,
     1 , -180 , -162 ,
     0 , -99 , -65 ,
     1 , -90 , -66 ,
     1 , -79 , -66 ,
     1 , -69 , -65 ,
     1 , -65 , -63 ,
     1 , -56 , -60 ,
     1 , -50 , -55 ,
     1 , -46 , -50 ,
     1 , -44 , -45 ,
     1 , -45 , -39 ,
     1 , -49 , -29 ,
     1 , -53 , -24 ,
     1 , -57 , -20 ,
     1 , -62 , -15 ,
     1 , -67 , -10 ,
     1 , -71 , -5 ,
     1 , -74 , 5 ,
     1 , -75 , 10 ,
     1 , -78 , 20 ,
     1 , -79 , 29 ,
     1 , -79 , 39 ,
     1 , -79 , 50 ,
     1 , -77 , 60 ,
     1 , -74 , 67 ,
     1 , -73 , 74 ,
     1 , -71 , 84 ,
     1 , -72 , 95 ,
     1 , -72 , 105 ,
     1 , -69 , 110 ,
     1 , -65 , 118 ,
     1 , -61 , 124 ,
     1 , -58 , 129 ,
     1 , -55 , 140 ,
     1 , -54 , 145 ,
     1 , -55 , 150 ,
     1 , -57 , 159 ,
     1 , -60 , 169 ,
     1 , -62 , 174 ,
     1 , -64 , 180 ,
     0 , -115 , -60 ,
     1 , -110 , -61 ,
     1 , -100 , -64 ,
     1 , -99 , -65 ,
     0 , -123 , -55 ,
     1 , -115 , -60 ,
     0 , -125 , -50 ,
     1 , -123 , -55 ,
     0 , -125 , -50 ,
     1 , -123 , -45 ,
     1 , -120 , -34 ,
     1 , -119 , -29 ,
     1 , -119 , -20 ,
     1 , -121 , -15 ,
     1 , -124 , -5 ,
     1 , -127 , 0 ,
     1 , -130 , 5 ,
     1 , -135 , 10 ,
     1 , -140 , 17 ,
     1 , -144 , 24 ,
     1 , -146 , 29 ,
     1 , -145 , 37 ,
     1 , -140 , 44 ,
     1 , -135 , 49 ,
     1 , -129 , 53 ,
     1 , -124 , 58 ,
     1 , -119 , 63 ,
     1 , -114 , 69 ,
     1 , -111 , 74 ,
     1 , -109 , 79 ,
     1 , -105 , 89 ,
     1 , -103 , 95 ,
     1 , -105 , 103 ,
     1 , -110 , 108 ,
     1 , -114 , 110 ,
     1 , -124 , 113 ,
     1 , -130 , 114 ,
     1 , -140 , 117 ,
     1 , -149 , 119 ,
     1 , -155 , 122 ,
     1 , -159 , 125 ,
     1 , -166 , 129 ,
     1 , -171 , 135 ,
     1 , -174 , 140 ,
     1 , -180 , 149 ,
     0 , 180 , 149 ,
     1 , 178 , 155 ,
     1 , 175 , 164 ,
     1 , 174 , 169 ,
     1 , 174 , 180 ,
     2 , 4 , 4 ,
     0 , -60 , -174 ,
     1 , -58 , -180 ,
     0 , 167 , -180 ,
     1 , 168 , -169 ,
     1 , 169 , -162 ,
     1 , 173 , -155 ,
     1 , 179 , -150 ,
     1 , 180 , -149 ,
     0 , -60 , -174 ,
     1 , -65 , -165 ,
     1 , -68 , -159 ,
     1 , -72 , -155 ,
     1 , -76 , -150 ,
     1 , -84 , -145 ,
     1 , -90 , -144 ,
     1 , -100 , -144 ,
     1 , -110 , -144 ,
     1 , -119 , -145 ,
     1 , -124 , -145 ,
     1 , -135 , -145 ,
     1 , -142 , -145 ,
     1 , -150 , -144 ,
     1 , -159 , -144 ,
     1 , -166 , -145 ,
     1 , -174 , -146 ,
     1 , -180 , -149 ,
     0 , -146 , -84 ,
     1 , -140 , -85 ,
     1 , -129 , -86 ,
     1 , -119 , -87 ,
     1 , -110 , -87 ,
     1 , -100 , -88 ,
     1 , -90 , -87 ,
     1 , -80 , -84 ,
     1 , -74 , -82 ,
     1 , -69 , -79 ,
     1 , -60 , -74 ,
     1 , -55 , -71 ,
     1 , -50 , -67 ,
     1 , -45 , -62 ,
     1 , -40 , -55 ,
     1 , -39 , -50 ,
     1 , -39 , -42 ,
     1 , -42 , -34 ,
     1 , -45 , -29 ,
     1 , -50 , -23 ,
     1 , -55 , -17 ,
     1 , -60 , -11 ,
     1 , -64 , -5 ,
     1 , -67 , 0 ,
     1 , -69 , 6 ,
     1 , -73 , 15 ,
     1 , -74 , 21 ,
     1 , -76 , 29 ,
     1 , -76 , 39 ,
     1 , -76 , 50 ,
     1 , -74 , 56 ,
     1 , -72 , 65 ,
     1 , -69 , 70 ,
     1 , -65 , 79 ,
     1 , -63 , 84 ,
     1 , -60 , 94 ,
     1 , -57 , 100 ,
     1 , -54 , 105 ,
     1 , -50 , 114 ,
     1 , -48 , 119 ,
     1 , -46 , 129 ,
     1 , -45 , 140 ,
     1 , -47 , 150 ,
     1 , -50 , 159 ,
     1 , -52 , 164 ,
     1 , -55 , 172 ,
     1 , -58 , 180 ,
     0 , -166 , -79 ,
     1 , -159 , -82 ,
     1 , -150 , -84 ,
     1 , -146 , -84 ,
     0 , -173 , -74 ,
     1 , -166 , -79 ,
     0 , -177 , -69 ,
     1 , -173 , -74 ,
     0 , -180 , -66 ,
     1 , -177 , -69 ,
     0 , 180 , -66 ,
     1 , 177 , -60 ,
     1 , 175 , -50 ,
     1 , 174 , -45 ,
     1 , 175 , -39 ,
     1 , 180 , -32 ,
     0 , -180 , -32 ,
     1 , -172 , -29 ,
     1 , -164 , -29 ,
     1 , -155 , -29 ,
     1 , -145 , -27 ,
     1 , -140 , -24 ,
     1 , -137 , -15 ,
     1 , -140 , -6 ,
     1 , -143 , 0 ,
     1 , -147 , 5 ,
     1 , -152 , 10 ,
     1 , -156 , 15 ,
     1 , -161 , 20 ,
     1 , -166 , 24 ,
     1 , -169 , 30 ,
     1 , -173 , 39 ,
     1 , -173 , 50 ,
     1 , -171 , 60 ,
     1 , -169 , 65 ,
     1 , -166 , 74 ,
     1 , -166 , 84 ,
     1 , -168 , 95 ,
     1 , -170 , 100 ,
     1 , -174 , 110 ,
     1 , -176 , 114 ,
     1 , -180 , 121 ,
     0 , 58 , 24 ,
     1 , 62 , 24 ,
     1 , 61 , 34 ,
     1 , 58 , 39 ,
     1 , 53 , 39 ,
     1 , 54 , 29 ,
     1 , 58 , 24 ,
     0 , 180 , 121 ,
     1 , 176 , 129 ,
     1 , 174 , 135 ,
     1 , 172 , 145 ,
     1 , 169 , 153 ,
     1 , 168 , 159 ,
     1 , 167 , 169 ,
     1 , 167 , 180 ,
     2 , 5 , 5 ,
     0 , -57 , -174 ,
     1 , -54 , -180 ,
     0 , 58 , -180 ,
     1 , 55 , -174 ,
     1 , 51 , -164 ,
     1 , 50 , -157 ,
     1 , 50 , -153 ,
     1 , 55 , -145 ,
     1 , 64 , -150 ,
     1 , 68 , -155 ,
     1 , 70 , -159 ,
     1 , 72 , -169 ,
     1 , 72 , -180 ,
     0 , 162 , -180 ,
     1 , 162 , -169 ,
     1 , 164 , -159 ,
     1 , 166 , -155 ,
     1 , 169 , -148 ,
     1 , 174 , -142 ,
     1 , 180 , -139 ,
     0 , -57 , -174 ,
     1 , -60 , -167 ,
     1 , -63 , -159 ,
     1 , -65 , -155 ,
     1 , -69 , -147 ,
     1 , -74 , -141 ,
     1 , -79 , -137 ,
     1 , -85 , -135 ,
     1 , -95 , -132 ,
     1 , -105 , -132 ,
     1 , -114 , -133 ,
     1 , -124 , -134 ,
     1 , -135 , -134 ,
     1 , -145 , -134 ,
     1 , -155 , -134 ,
     1 , -164 , -135 ,
     1 , -169 , -135 ,
     1 , -180 , -139 ,
     0 , -153 , -100 ,
     1 , -145 , -100 ,
     1 , -135 , -101 ,
     1 , -124 , -102 ,
     1 , -114 , -103 ,
     1 , -105 , -103 ,
     1 , -95 , -103 ,
     1 , -84 , -100 ,
     1 , -79 , -98 ,
     1 , -73 , -95 ,
     1 , -66 , -90 ,
     1 , -60 , -85 ,
     1 , -55 , -81 ,
     1 , -50 , -77 ,
     1 , -45 , -72 ,
     1 , -39 , -66 ,
     1 , -36 , -60 ,
     1 , -35 , -50 ,
     1 , -37 , -39 ,
     1 , -39 , -34 ,
     1 , -45 , -26 ,
     1 , -49 , -20 ,
     1 , -53 , -15 ,
     1 , -57 , -10 ,
     1 , -60 , -5 ,
     1 , -65 , 2 ,
     1 , -69 , 10 ,
     1 , -70 , 15 ,
     1 , -73 , 24 ,
     1 , -74 , 34 ,
     1 , -74 , 45 ,
     1 , -74 , 55 ,
     1 , -70 , 65 ,
     1 , -68 , 69 ,
     1 , -64 , 74 ,
     1 , -60 , 84 ,
     1 , -56 , 90 ,
     1 , -53 , 95 ,
     1 , -50 , 100 ,
     1 , -45 , 109 ,
     1 , -42 , 114 ,
     1 , -40 , 124 ,
     1 , -39 , 129 ,
     1 , -39 , 135 ,
     1 , -41 , 145 ,
     1 , -44 , 155 ,
     1 , -46 , 159 ,
     1 , -50 , 168 ,
     1 , -52 , 174 ,
     1 , -54 , 180 ,
     0 , -172 , -95 ,
     1 , -164 , -97 ,
     1 , -155 , -99 ,
     1 , -153 , -100 ,
     0 , -178 , -90 ,
     1 , -172 , -95 ,
     0 , -180 , -88 ,
     1 , -178 , -90 ,
     0 , 63 , -84 ,
     1 , 69 , -87 ,
     1 , 74 , -81 ,
     1 , 78 , -74 ,
     1 , 80 , -69 ,
     1 , 82 , -60 ,
     1 , 82 , -50 ,
     1 , 80 , -39 ,
     1 , 74 , -38 ,
     1 , 74 , -45 ,
     1 , 74 , -55 ,
     1 , 73 , -65 ,
     1 , 69 , -69 ,
     1 , 65 , -79 ,
     1 , 63 , -84 ,
     0 , 180 , -88 ,
     1 , 174 , -81 ,
     1 , 172 , -74 ,
     1 , 169 , -68 ,
     1 , 168 , -60 ,
     1 , 166 , -50 ,
     1 , 166 , -39 ,
     1 , 168 , -29 ,
     1 , 171 , -24 ,
     1 , 180 , -20 ,
     0 , -180 , -20 ,
     1 , -169 , -20 ,
     1 , -164 , -19 ,
     1 , -155 , -17 ,
     1 , -151 , -10 ,
     1 , -155 , 0 ,
     1 , -159 , 5 ,
     1 , -164 , 10 ,
     1 , -169 , 15 ,
     1 , -174 , 20 ,
     1 , -178 , 24 ,
     1 , -180 , 27 ,
     0 , 64 , 5 ,
     1 , 69 , 1 ,
     1 , 72 , 10 ,
     1 , 72 , 20 ,
     1 , 71 , 29 ,
     1 , 70 , 39 ,
     1 , 68 , 45 ,
     1 , 66 , 55 ,
     1 , 63 , 60 ,
     1 , 60 , 66 ,
     1 , 50 , 65 ,
     1 , 46 , 60 ,
     1 , 44 , 55 ,
     1 , 43 , 45 ,
     1 , 45 , 37 ,
     1 , 48 , 29 ,
     1 , 50 , 24 ,
     1 , 55 , 17 ,
     1 , 60 , 10 ,
     1 , 64 , 5 ,
     0 , 180 , 27 ,
     1 , 176 , 34 ,
     1 , 174 , 39 ,
     1 , 173 , 50 ,
     1 , 174 , 60 ,
     1 , 174 , 69 ,
     1 , 175 , 74 ,
     1 , 175 , 84 ,
     1 , 175 , 95 ,
     1 , 174 , 100 ,
     1 , 173 , 110 ,
     1 , 171 , 119 ,
     1 , 169 , 124 ,
     1 , 167 , 135 ,
     1 , 165 , 145 ,
     1 , 164 , 150 ,
     1 , 163 , 159 ,
     1 , 162 , 169 ,
     1 , 162 , 180 ,
     0 , 63 , 169 ,
     1 , 69 , 166 ,
     1 , 72 , 174 ,
     1 , 72 , 180 ,
     0 , 59 , 174 ,
     1 , 63 , 169 ,
     0 , 58 , 180 ,
     2 , 6 , 6 ,
     1 , 59 , 174 ,
     0 , -52 , -180 ,
     1 , -55 , -173 ,
     1 , -58 , -164 ,
     1 , -60 , -159 ,
     1 , -64 , -150 ,
     1 , -66 , -145 ,
     1 , -69 , -138 ,
     1 , -74 , -130 ,
     1 , -79 , -124 ,
     1 , -80 , -119 ,
     1 , -79 , -114 ,
     1 , -74 , -108 ,
     1 , -69 , -103 ,
     1 , -65 , -98 ,
     1 , -60 , -93 ,
     1 , -55 , -88 ,
     1 , -50 , -84 ,
     1 , -44 , -79 ,
     1 , -39 , -74 ,
     1 , -34 , -68 ,
     1 , -32 , -60 ,
     1 , -32 , -50 ,
     1 , -34 , -40 ,
     1 , -37 , -34 ,
     1 , -40 , -29 ,
     1 , -45 , -23 ,
     1 , -50 , -16 ,
     1 , -54 , -10 ,
     1 , -58 , -5 ,
     1 , -61 , 0 ,
     1 , -65 , 6 ,
     1 , -69 , 15 ,
     1 , -70 , 20 ,
     1 , -72 , 29 ,
     1 , -73 , 39 ,
     1 , -74 , 50 ,
     1 , -71 , 60 ,
     1 , -69 , 65 ,
     1 , -65 , 71 ,
     1 , -60 , 79 ,
     1 , -56 , 84 ,
     1 , -53 , 90 ,
     1 , -49 , 95 ,
     1 , -45 , 100 ,
     1 , -39 , 108 ,
     1 , -37 , 114 ,
     1 , -35 , 124 ,
     1 , -36 , 135 ,
     1 , -38 , 145 ,
     1 , -39 , 150 ,
     1 , -43 , 159 ,
     1 , -45 , 164 ,
     1 , -50 , 174 ,
     1 , -52 , 180 ,
     0 , 53 , -180 ,
     1 , 50 , -171 ,
     1 , 47 , -164 ,
     1 , 45 , -156 ,
     1 , 44 , -150 ,
     1 , 45 , -143 ,
     1 , 49 , -135 ,
     1 , 55 , -132 ,
     1 , 61 , -135 ,
     1 , 66 , -140 ,
     1 , 70 , -145 ,
     1 , 74 , -155 ,
     1 , 75 , -159 ,
     1 , 77 , -169 ,
     1 , 78 , -180 ,
     0 , 158 , -180 ,
     1 , 158 , -169 ,
     1 , 159 , -161 ,
     1 , 161 , -155 ,
     1 , 164 , -146 ,
     1 , 169 , -140 ,
     1 , 173 , -135 ,
     1 , 178 , -129 ,
     1 , 180 , -128 ,
     0 , -180 , -128 ,
     1 , -174 , -124 ,
     1 , -170 , -114 ,
     1 , -175 , -110 ,
     1 , -180 , -105 ,
     0 , 180 , -105 ,
     1 , 175 , -100 ,
     1 , 172 , -95 ,
     1 , 169 , -90 ,
     1 , 166 , -79 ,
     1 , 164 , -74 ,
     1 , 163 , -65 ,
     1 , 162 , -55 ,
     1 , 161 , -45 ,
     1 , 161 , -34 ,
     1 , 163 , -24 ,
     1 , 165 , -20 ,
     1 , 170 , -15 ,
     1 , 180 , -12 ,
     0 , 54 , -100 ,
     1 , 60 , -104 ,
     1 , 67 , -100 ,
     1 , 72 , -95 ,
     1 , 75 , -90 ,
     1 , 79 , -81 ,
     1 , 82 , -74 ,
     1 , 84 , -65 ,
     1 , 85 , -60 ,
     1 , 85 , -50 ,
     1 , 85 , -39 ,
     1 , 83 , -34 ,
     1 , 80 , -24 ,
     1 , 79 , -20 ,
     1 , 78 , -10 ,
     1 , 78 , 0 ,
     1 , 78 , 10 ,
     1 , 77 , 20 ,
     1 , 76 , 29 ,
     1 , 75 , 39 ,
     1 , 74 , 45 ,
     1 , 73 , 55 ,
     1 , 71 , 65 ,
     1 , 69 , 72 ,
     1 , 67 , 79 ,
     1 , 65 , 87 ,
     1 , 55 , 84 ,
     1 , 50 , 80 ,
     1 , 45 , 74 ,
     1 , 41 , 69 ,
     1 , 39 , 65 ,
     1 , 37 , 55 ,
     1 , 39 , 45 ,
     1 , 40 , 39 ,
     1 , 44 , 29 ,
     1 , 47 , 24 ,
     1 , 50 , 20 ,
     1 , 55 , 12 ,
     1 , 59 , 5 ,
     1 , 63 , 0 ,
     1 , 67 , -5 ,
     1 , 69 , -11 ,
     1 , 73 , -20 ,
     1 , 73 , -29 ,
     1 , 73 , -39 ,
     1 , 74 , -50 ,
     1 , 72 , -60 ,
     1 , 69 , -65 ,
     1 , 65 , -74 ,
     1 , 60 , -79 ,
     1 , 58 , -84 ,
     1 , 55 , -93 ,
     1 , 54 , -100 ,
     0 , -180 , -12 ,
     1 , -169 , -11 ,
     1 , -164 , -6 ,
     1 , -164 , -3 ,
     1 , -169 , 5 ,
     1 , -174 , 10 ,
     1 , -179 , 15 ,
     1 , -180 , 15 ,
     0 , 180 , 15 ,
     1 , 174 , 22 ,
     1 , 170 , 29 ,
     1 , 169 , 34 ,
     1 , 167 , 45 ,
     1 , 166 , 55 ,
     1 , 167 , 65 ,
     1 , 167 , 74 ,
     1 , 167 , 84 ,
     1 , 167 , 95 ,
     1 , 166 , 105 ,
     1 , 165 , 114 ,
     1 , 164 , 119 ,
     1 , 163 , 129 ,
     1 , 162 , 140 ,
     1 , 160 , 150 ,
     1 , 159 , 155 ,
     1 , 159 , 164 ,
     1 , 158 , 174 ,
     1 , 158 , 180 ,
     0 , 67 , 150 ,
     1 , 73 , 150 ,
     1 , 75 , 155 ,
     1 , 77 , 164 ,
     1 , 78 , 174 ,
     1 , 78 , 180 ,
     0 , 64 , 155 ,
     1 , 67 , 150 ,
     0 , 64 , 155 ,
     1 , 60 , 164 ,
     1 , 58 , 169 ,
     1 , 55 , 176 ,
     1 , 55 , 180 ,
];
// }}}
		var currx = [], curry = [];
		for(var cdi=0; cdi < contourdata.length; cdi+=3) {
			if(contourdata[cdi] == 0) {
				if(currx.length > 1) {
					var cpath = [];
					for(ci=0; ci < currx.length; ci++) {
						if(ci==0) cpath.push("M");
						else      cpath.push("L");
						var rxy = self.phipsiToRaphaXY(currx[ci],curry[ci]);
						cpath.push( rxy[0] ); cpath.push( rxy[1] );
					}
					self.rapha.rapha.path(cpath).attr({stroke:self.colormaker.getRandomColor()});
				}
				currx = []; curry = [];
				if(contourdata[cdi]==0) { currx.push(contourdata[cdi+1]); curry.push(contourdata[cdi+2]); }
			}
			if(contourdata[cdi] == 1) { currx.push(contourdata[cdi+1]); curry.push(contourdata[cdi+2]); }
		}
	},
	draw: function() {
		var self = this;
		if(!self.rapha) self.rapha = new Biojs.RaphaelCanvas({divid:self.raphadivid, dimension:self.raphadivheight});
		self.rapha.rapha.clear();
		self.drawAxes();
		self.drawRamaContours();
		if(self.chainids == null) { self.updateNowshowing("Not showing any chain now."); return; }
		self.decideChainToShow();
		self.updateNowshowing("Cannot plot for chain " + self.chainids.chain + " (entity " + self.chainids.entity + ", model " + self.chainids.model+").");
		if(!self.chain) return;
		var rama = self.chain.getRamaRotaListing()[self.model];
		jQuery.each(self.chain.getResidueListing(), function(ri,rd) {
			if(!rama[rd.seq]) return;
			if(!rama[rd.seq].phi || !rama[rd.seq].psi) return;
			self.drawResidue(rd, rama[rd.seq], rama[rd.seq].phi, rama[rd.seq].psi);
			//self.drawResidue(rd, Math.random()*360-180, Math.random()*360-180);
		});
		self.updateNowshowing();
	},
	updateNowshowing: function(nowshowing) {
		var self = this;
		//if(nowshowing=="cannot") {
			//if(self.chainids) nowshowing = self.updateNowshowing("Cannot plot for chain " + self.chainids.chain + " in entity " + self.chainids.entity + " and model " + self.chainids.model);
		//}
		//else nowshowing = "Not showing any chain.";
		if(!nowshowing) nowshowing = "Showing chain " + self.chain.getAuthAsymId() + " (entity " + self.entity.getEid() + ", model " + self.model + ").";
		document.getElementById(self.menudivid).innerHTML = "<a title='"+nowshowing+"'>"+nowshowing+"</a>";
	},
	// decide which model, entity, chain to show rama for. if ids are specified elsewhere, use that to make self.model, self.entity, self.chain
	decideChainToShow: function() {
		var self = this;
		self.entity = null; self.chain = null; self.model = null;
		jQuery.each( self.entry.entities, function(ei,ent) {
			if(self.chainids && self.chainids.entity+'' != ''+ent.getEid()) return;
			if(self.chain != null) return;
			if(ent.isType("protein") == false) return;
			jQuery.each( ent.instances, function(ci,chain) {
				if(self.chainids && self.chainids.chain+'' != ''+chain.getAuthAsymId()) return;
				if(self.chain != null) return;
				self.entity = ent; self.chain = chain;
				if(self.chainids && self.chainids.model) {
					self.model = self.chainids.model;
				}
				else {
					for(mid in chain.getRamaRotaListing()) { self.model = mid; break; }
				}
			} );
		} );
	},
	phipsiToRaphaXY: function(phi,psi) {
		var self = this;
		if(!self.margin) self.margin = 10;
		if(!self.deg2len) self.deg2len = (self.raphadivheight - 2*self.margin)/360;
		return [self.raphadivheight / 2 + self.deg2len * phi, self.raphadivheight / 2 - self.deg2len * psi];
	},
	drawResidue: function(resinfo, ramainfo, phi, psi) {
		var self = this;
		var xy = self.phipsiToRaphaXY(phi,psi), fillcolor="grey";
		if(ramainfo.rama=="OUTLIER" || ramainfo.rota=="OUTLIER") fillcolor = "red";
		else if(ramainfo.rama == "Allowed") fillcolor = "yellow";
		else if(ramainfo.rama == "Favored") fillcolor = "green";
		var t = self.rapha.rapha.circle(xy[0], xy[1], self.deg2len*3).attr({fill:fillcolor});
		jQuery(t.node).attr("title","dummy");
		jQuery(t.node).click(function() {
			jQuery.Topic("ResidueHoverEvent").publish({
				pdbid:self.entity.getPdbid(), entity:self.entity.getEid(), chain: self.chain.getAuthAsymId(), seq:resinfo.seq, sourcediv:self.divid
			});
		});
		jQuery(t.node).tooltip({
			show: { effect: "blind", duration: 10 },
			content: function() {
				var rinf = "["+ramainfo.rama;
				if(ramainfo.rota) rinf += ","+ramainfo.rota;
				if(rinf.length > 2) rinf += "]";
				else rinf = "";
				var el = t.glow();
				el.animate({opacity:0}, 1000, function(){this.remove()});
				return ((resinfo.resname+"("+self.chain.getAuthAsymId()+":"+resinfo.resnum+resinfo.inscode+")"+" "+ rinf).replace(/ /g,''));
			}
		});
	}
} );
